<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Arborescences · Atlas des formes littéraires</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cinzel+Decorative:wght@400;700&family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0c1220;--gold:#c9a227;--gold-light:#e8d078;--cream:#e8dcc8;
  --text-dim:#7a6e5f;--text-faint:rgba(122,110,95,0.5);
  --border-subtle:rgba(201,162,39,0.18);--border-gold:rgba(201,162,39,0.4);
  --card-bg:rgba(15,25,45,0.7);
}
body{background:var(--bg);color:var(--cream);font-family:'EB Garamond',serif;min-height:100vh;
  background-image:radial-gradient(ellipse at 50% 0%,rgba(30,60,100,0.12) 0%,transparent 60%)}
.site-nav{display:flex;align-items:center;justify-content:space-between;padding:14px 44px;border-bottom:1px solid var(--border-subtle);background:rgba(12,18,32,0.97);position:sticky;top:0;z-index:200;backdrop-filter:blur(14px)}
.nav-brand{display:flex;align-items:center;gap:12px;text-decoration:none}
.nav-diamond{color:var(--gold);font-size:.52rem}
.nav-brand-text{font-family:'Cinzel',serif;font-size:.73rem;letter-spacing:.22em;text-transform:uppercase;color:var(--gold-light)}
.nav-links{display:flex;gap:36px}
.nav-link{font-family:'Cinzel',serif;font-size:.68rem;letter-spacing:.18em;text-transform:uppercase;color:var(--text-dim);text-decoration:none;transition:color .22s;padding-bottom:2px;border-bottom:1px solid transparent}
.nav-link:hover{color:var(--gold-light);border-bottom-color:rgba(201,162,39,.3)}
.nav-link.active{color:var(--gold-light);border-bottom-color:var(--gold)}
@media(max-width:640px){.site-nav{padding:12px 20px}.nav-links{gap:16px}.nav-link{font-size:.6rem}}

header{text-align:center;padding:30px 20px 4px}
.header-ornament{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:14px}
.header-line{flex:1;max-width:160px;height:1px;background:linear-gradient(to right,transparent,var(--gold))}
.header-line.right{background:linear-gradient(to left,transparent,var(--gold))}
.header-diamond{width:8px;height:8px;background:var(--gold);transform:rotate(45deg);opacity:.7}
.title-main{font-family:'Cinzel Decorative',serif;font-size:clamp(1.1rem,2.5vw,1.85rem);color:var(--gold-light);letter-spacing:.03em;text-shadow:0 0 50px rgba(201,162,39,.2)}
.title-sub{font-family:'Cinzel',serif;font-size:clamp(.5rem,.95vw,.66rem);letter-spacing:.35em;text-transform:uppercase;color:var(--text-dim);margin-top:8px}

.section-label{text-align:center;font-family:'Cinzel',serif;font-size:.66rem;letter-spacing:.3em;text-transform:uppercase;color:var(--text-faint);padding:20px 20px 8px}
.btn-row{display:flex;justify-content:center;flex-wrap:wrap;gap:8px;padding:4px 20px 14px}
.tree-btn{background:transparent;border:1px solid var(--border-subtle);color:var(--text-dim);font-family:'Cinzel',serif;font-size:.82rem;letter-spacing:.18em;text-transform:uppercase;padding:10px 26px;cursor:pointer;transition:all .28s;outline:none}
.tree-btn:hover{color:var(--gold-light);border-color:rgba(201,162,39,.55);background:rgba(201,162,39,.05)}
.tree-btn.active{background:var(--gold);border-color:var(--gold);color:var(--bg)}

.tree-desc{text-align:center;font-style:italic;color:var(--text-dim);font-size:1.02rem;padding:4px 30px 16px;max-width:820px;margin:0 auto;line-height:1.6;min-height:32px}
.thin-divider{max-width:700px;margin:2px auto 0;height:1px;background:linear-gradient(to right,transparent,rgba(201,162,39,.12),transparent)}

/* Tree container */
.tree-wrapper{width:100%;overflow-x:auto;padding:10px 20px 30px;display:flex;justify-content:center}
#tree-svg{display:block}

/* Node styles */
.node-group{cursor:pointer}
.node-circle{stroke-width:1.8;transition:r .2s}
.node-label{font-family:'Cinzel',serif;font-size:11px;fill:var(--cream);pointer-events:none;dominant-baseline:middle}
.node-year{font-family:'Cinzel',serif;font-size:9px;fill:var(--text-dim);pointer-events:none;dominant-baseline:middle}
.tree-link{fill:none;stroke:rgba(201,162,39,.25);stroke-width:1.4}
.tree-link-hybrid{stroke-dasharray:5,3;stroke:rgba(224,96,64,.35)}

/* Detail panel */
.detail-panel{max-width:860px;margin:0 auto;padding:0 30px 20px}
.detail-inner{background:var(--card-bg);border:1px solid var(--border-subtle);padding:18px 24px;min-height:80px;position:relative;overflow:hidden;transition:all .3s}
.detail-inner::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(201,162,39,.03) 0%,transparent 60%);pointer-events:none}
.detail-title{font-family:'Cinzel',serif;font-size:.9rem;font-weight:600;color:var(--gold-light);letter-spacing:.06em;margin-bottom:8px}
.detail-meta{font-family:'Cinzel',serif;font-size:.68rem;letter-spacing:.1em;color:var(--text-dim);margin-bottom:10px}
.detail-text{font-size:1.02rem;color:var(--cream);line-height:1.65;opacity:.88}
.detail-placeholder{font-style:italic;color:var(--text-faint);font-size:.95rem;padding:14px 0}

/* Legend */
.legend{display:flex;align-items:center;justify-content:center;gap:28px;padding:10px 20px 4px;flex-wrap:wrap}
.legend-item{display:flex;align-items:center;gap:8px;font-family:'Cinzel',serif;font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;color:var(--text-dim)}
.legend-dot{width:10px;height:10px;border-radius:50%;border:1.5px solid}
.legend-line{width:24px;height:2px}
.legend-dline{width:24px;height:2px;background:repeating-linear-gradient(to right,rgba(224,96,64,.5) 0,rgba(224,96,64,.5) 4px,transparent 4px,transparent 7px)}

.moretti-note{max-width:840px;margin:14px auto 0;padding:0 30px;font-style:italic;color:var(--text-faint);font-size:.88rem;line-height:1.6;text-align:center}

.orn-div{display:flex;align-items:center;gap:18px;max-width:900px;margin:28px auto 0;padding:0 30px}
.orn-line{flex:1;height:1px;background:linear-gradient(to right,transparent,rgba(201,162,39,.15),transparent)}
.orn-text{font-family:'Cinzel',serif;font-size:.6rem;letter-spacing:.26em;text-transform:uppercase;color:var(--text-faint);white-space:nowrap}

footer{text-align:center;padding:30px 20px 24px;font-family:'Cinzel',serif;font-size:.55rem;letter-spacing:.22em;text-transform:uppercase;color:rgba(122,110,95,.32);border-top:1px solid var(--border-subtle);margin-top:40px}
</style>
</head>
<body>

<nav class="site-nav">
  <a class="nav-brand" href="index.html"><span class="nav-diamond">◆</span><span class="nav-brand-text">Atlas · Formes Littéraires</span></a>
  <div class="nav-links">
    <a href="index.html" class="nav-link">Accueil</a>
    <a href="atlas.html" class="nav-link">Atlas</a>
    <a href="trees.html" class="nav-link active">Arborescences</a>
    <a href="contact.html" class="nav-link">Contact</a>
  </div>
</nav>

<header>
  <div class="header-ornament">
    <div class="header-line"></div><div class="header-diamond"></div>
    <div class="header-diamond" style="opacity:.4;transform:rotate(45deg) scale(.65)"></div>
    <div class="header-diamond"></div><div class="header-line right"></div>
  </div>
  <div class="title-main">Arborescences des formes littéraires</div>
  <div class="title-sub">Évolution, spéciation et hybridation des genres · modèles phylogénétiques</div>
</header>

<div class="section-label">Arbre générique</div>
<div class="btn-row">
  <button class="tree-btn active" data-tree="roman" onclick="switchTree('roman')">Roman & Épopée</button>
  <button class="tree-btn" data-tree="poesie" onclick="switchTree('poesie')">Poésie en vers</button>
</div>
<p class="tree-desc" id="tree-desc"></p>
<div class="thin-divider"></div>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:rgba(212,168,73,.18);border-color:#c9a227"></div>Forme principale</div>
  <div class="legend-item"><div class="legend-dot" style="background:rgba(100,180,150,.18);border-color:#5ab08a"></div>Sous-genre / ramification</div>
  <div class="legend-item"><div class="legend-dot" style="background:rgba(180,100,200,.18);border-color:#b464c8"></div>Hybride / synthèse</div>
  <div class="legend-item"><div class="legend-line" style="background:rgba(201,162,39,.35)"></div>Filiation directe</div>
  <div class="legend-item"><div class="legend-dline"></div>Hybridation / emprunt</div>
</div>

<div class="tree-wrapper"><svg id="tree-svg"></svg></div>

<div class="detail-panel">
  <div class="detail-inner" id="detail-inner">
    <p class="detail-placeholder">Cliquez sur un nœud pour afficher les détails.</p>
  </div>
</div>

<p class="moretti-note">
  Ces arborescences sont inspirées de la méthode de Franco Moretti dans « The Slaughterhouse of Literature » (<em>MLQ</em>, 2000) et <em>Graphs, Maps, Trees</em> (2005) : les formes littéraires y sont traitées comme des espèces qui se ramifient, s'hybrident et parfois disparaissent — sans que cela implique un déterminisme téléologique. Les liens tiretés signalent des hybridations documentées, les liens continus des filiations génériques directes.
</p>

<div class="orn-div"><div class="orn-line"></div><span class="orn-text">Note méthodologique</span><div class="orn-line"></div></div>

<footer>Sources : Moretti, <em>Graphs, Maps, Trees</em> (2005) · Schaeffer, <em>Qu'est-ce qu'un genre littéraire ?</em> (1989) · données provisoires</footer>

<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script>
/* ═══════════════════════════════════════
   TREE DATA
   Each node: { id, label, year, type, detail, children? }
   type: "root" | "main" | "branch" | "hybrid"
   Edges with hybrid:true render as dashed
   ═══════════════════════════════════════ */
const TREES = {
  roman: {
    desc: "De l'épopée orale sumérienne au roman policier scandinave : sept millénaires de spéciation du récit de fiction en prose. Les hybridations (tirets) signalent les emprunts trans-génériques documentés.",
    root: {
      id:"epopee", label:"Épopée orale", year:"c. 2100 av. J.-C.", type:"root",
      detail:"Gilgamesh (Mésopotamie, c. 2100 av. J.-C.) est la première épopée attestée. Forme à la fois cosmogonique, héroïque et poétique. Elle définit les structures narratives fondamentales du récit long : quête, compagnon, descente aux enfers, retour transformé.",
      children:[
        { id:"epopee-gr", label:"Épopée grecque", year:"c. 750 av. J.-C.", type:"main",
          detail:"Iliade et Odyssée d'Homère : épopée héroïque en hexamètres. Structure en épisodes, digressions, analepses. L'Odyssée introduit le 'roman d'aventure' avant la lettre par son héros rusé, ses voyages et ses retours.",
          children:[
            { id:"roman-grec", label:"Roman grec antique", year:"Ier–IIIe s.", type:"branch",
              detail:"Chariton, Longus (Daphnis et Chloé), Héliodore (Éthiopiques). Premiers romans au sens moderne : récit en prose à protagoniste individuel, intrigue amoureuse, péripéties. Influence massive sur la Renaissance européenne.",
              children:[
                { id:"roman-pastoral", label:"Roman pastoral", year:"XVIe s.", type:"branch",
                  detail:"Jorge de Montemayor (Diana, 1559), Sir Philip Sidney (Arcadia, 1590). Dérivé du roman grec, du Décaméron et de l'éclogue virgilienne. Déclin au XVIIe s. avec l'essor du roman psychologique."},
                { id:"roman-baroque", label:"Roman baroque / héroïque", year:"XVIIe s.", type:"branch",
                  detail:"L'Astrée (d'Urfé, 1607–1627), Grand Cyrus (Madeleine de Scudéry). Roman fleuve de plusieurs milliers de pages, galanterie précieuse, géographie fictive. Parodié par Cervantes et Furetière."}
              ]},
            { id:"roman-chevaleresque", label:"Roman chevaleresque", year:"XIIe s.", type:"main",
              detail:"Chrétien de Troyes (Lancelot, Perceval, c. 1170–1190). Récit en octosyllabes puis en prose. Quête du Graal, amour courtois, merveilleux. La 'matière de Bretagne' diffuse le genre dans toute l'Europe.",
              children:[
                { id:"roman-arthurien", label:"Cycle arthurien en prose", year:"XIIIe s.", type:"branch",
                  detail:"Lancelot-Graal (c. 1215–1235) : premier grand roman-cycle en prose française. Entrelacement narratif de plusieurs quêtes simultanées. Modèle structurel du roman-fleuve moderne."},
                { id:"picaresque", label:"Roman picaresque", year:"XVIe s.", type:"branch",
                  detail:"Lazarillo de Tormes (anon., 1554), Guzmán de Alfarache (Alemán, 1599). Anti-héros roturier, récit à la première personne, satire sociale. Ancêtre du roman de formation (Bildungsroman).",
                  children:[
                    { id:"bildungsroman", label:"Bildungsroman", year:"XVIIIe–XIXe s.", type:"main",
                      detail:"Wilhelm Meister (Goethe, 1795–1796), David Copperfield (Dickens, 1850), L'Éducation sentimentale (Flaubert, 1869). Roman de la formation d'un sujet : croissance, désillusion, socialisation. Forme dominante du XIXe siècle européen.",
                      children:[
                        { id:"roman-moderniste", label:"Roman moderniste", year:"XXe s.", type:"main",
                          detail:"Mrs Dalloway (Woolf, 1925), Ulysse (Joyce, 1922), La Montagne magique (Mann, 1924). Monologue intérieur, fragmentation temporelle, conscience en flux. Dissolution du récit linéaire hérité du XIXe s."}
                      ]}
                  ]}
              ]}
          ]},
        { id:"conte", label:"Conte & nouvelle", year:"XIVe s.", type:"branch",
          detail:"Décaméron (Boccace, 1349–1353) : 100 nouvelles encadrées. Forme brève autonome, économie de moyens, chute. Influence directe sur Marguerite de Navarre, La Fontaine, Maupassant, Tchekhov.",
          children:[
            { id:"nouvelle-realiste", label:"Nouvelle réaliste", year:"XIXe s.", type:"branch",
              detail:"Maupassant, Tchekhov, Flaubert (Trois Contes). La nouvelle réaliste définit les codes du genre court : scène inaugurale, tension, chute ou épiphanie. Chekhov introduce le 'non-event' comme événement narratif."}
          ]},
        { id:"roman-moderne", label:"Roman réaliste / naturaliste", year:"XIXe s.", type:"main",
          detail:"Balzac (La Comédie humaine, 1830–1856), Flaubert, Zola, Tolstoï, Dickens. Roman comme document social total. Description systématique du milieu, déterminisme, personnages typiques. Forme hégémonique de la littérature bourgeoise européenne.",
          children:[
            { id:"roman-policier", label:"Roman policier", year:"1841–", type:"branch",
              detail:"Poe (1841) → Conan Doyle (1887) → Agatha Christie (whodunit) → Chandler (hard-boiled) → Simenon (roman de mœurs) → Sjöwall & Wahlöö (polar social). Voir l'Atlas cartographique pour la diffusion géographique.",
              children:[
                { id:"polar-scandi", label:"Polar scandinave", year:"1965–", type:"branch",
                  detail:"Sjöwall & Wahlöö (Martin Beck, 1965–1975) fondent le polar social nordique. Stieg Larsson (Millénium, 2005–2007) le mondialise. Forme la plus lue et traduite du début du XXIe siècle."},
                { id:"roman-noir", label:"Roman noir / néo-noir", year:"1930–", type:"branch",
                  detail:"Dashiell Hammett, Raymond Chandler, James M. Cain. Hard-boiled américain : prose sèche, violence sociale, ville corrompue. Influence sur le cinéma noir et le roman latino-américain."}
              ]},
            { id:"roman-sf", label:"Science-fiction / Fantasy", year:"1818–", type:"hybrid",
              detail:"Frankenstein (M. Shelley, 1818), 20 000 lieues sous les mers (Verne, 1870), La Guerre des mondes (Wells, 1898). Hybride de roman réaliste et de récit merveilleux/utopique. Se ramifie en SF hard, space opera, dystopie, cyberpunk.",
              hybrid:true}
          ]}
      ]
    }
  },
  poesie: {
    desc: "De l'hymne védique et de l'ode sapphique au slam mondial et au haïku numérique : évolution comparée des formes poétiques fixes et libres à l'échelle mondiale.",
    root: {
      id:"poesie-orale", label:"Poésie orale archaïque", year:"c. 1500 av. J.-C.", type:"root",
      detail:"Hymnes du Rig-Véda (Inde, c. 1500 av. J.-C.), psaumes hébraïques (c. 1000 av. J.-C.), vers homériques (c. 750 av. J.-C.). Poésie orale mémorisée, liée au rituel, à l'éloge et à la lamentation. Formes prosodiques basées sur la quantité syllabique (grec, sanskrit) ou l'accentuation (hébreu, germanique).",
      children:[
        { id:"lyrique-gr", label:"Lyrique grecque", year:"VIIe–Ve s. av. J.-C.", type:"main",
          detail:"Sappho, Alcée, Pindare. Odes métriques chantées avec accompagnement de lyre. Première poésie du 'moi' lyrique au sens moderne. Structures strophiques strictes (strophe/antistrophe/épode chez Pindare).",
          children:[
            { id:"ode-latine", label:"Ode latine & lyrique romaine", year:"Ier s. av. J.-C.", type:"branch",
              detail:"Horace (Odes), Catulle, Ovide. Adaptation des mètres grecs au latin. Horace codifie l'ode comme méditation éthique sur la temporalité (carpe diem). Influence directe sur toute la lyrique européenne de la Renaissance."},
            { id:"sonnet", label:"Sonnet", year:"XIIIe s.–", type:"main",
              detail:"Jacopo da Lentini (c. 1230–1250) : invention du sonnet en Sicile. Pétrarque (Canzoniere, 1327–1374) l'élève au rang de forme canonique. 14 vers, deux quatrains, deux tercets (ou trois quatrains + couplet : sonnet shakespearien). Forme persistante jusqu'au XXIe siècle.",
              children:[
                { id:"sonnet-mod", label:"Sonnet moderniste & néo-sonnet", year:"XXe s.", type:"branch",
                  detail:"Rilke (Sonnets à Orphée, 1923), Berryman (Dream Songs), Seamus Heaney. Le sonnet survit en se déformant : vers libres, ruptures syntaxiques, absence de rime. 'Forme contrainte librement habitée'."}
              ]},
            { id:"troubadour", label:"Poésie des troubadours", year:"XIe–XIIIe s.", type:"branch",
              detail:"Guilhem IX, Bernart de Ventadorn, Arnaut Daniel. Lyrique occitane : canso, alba, sirventes. Amour courtois, fin'amor. Diffusée en Italie (dolce stil novo : Dante, Cavalcanti), en Allemagne (Minnesang), en Castille.",
              children:[
                { id:"ghazal", label:"Ghazal (lyrique islamique)", year:"VIIe s.–", type:"hybrid",
                  detail:"Forme poétique arabo-persane de l'amour mystique et profane. Hafez (XIVe s.) la porte à son sommet. Reprise par Goethe (Divan occidental-oriental, 1819), Rumi, et contemporains (Agha Shahid Ali).",
                  hybrid:true}
              ]}
          ]},
        { id:"epopee-poesie", label:"Épopée versifiée", year:"c. 750 av. J.-C.", type:"main",
          detail:"Iliade, Odyssée, Énéide, Mahābhārata, Rāmāyaṇa. Récit héroïque en vers, transmission orale puis fixation écrite. Forme à la fois poétique et narrative, lieu de mémoire culturelle.",
          children:[
            { id:"poeme-epique-mod", label:"Poème épique moderne", year:"XVIe–XVIIe s.", type:"branch",
              detail:"L'Orlando furioso (Arioste, 1516), Os Lusíadas (Camões, 1572), Paradise Lost (Milton, 1667). Épopée de la Renaissance et du baroque : allégorisation, complexité narrative, rupture de la naïveté orale."},
            { id:"haiku-tr", label:"Hokku → Haïku", year:"XVIIe s.–", type:"branch",
              detail:"Matsuo Bashō (1644–1694) élève le hokku au rang de poème autonome. Masaoka Shiki forge le terme 'haïku' (1897). Forme minimaliste (5-7-5 more) à kigo et kireji. Diffusion mondiale au XXe s. Voir l'Atlas cartographique.",
              children:[
                { id:"haiku-monde", label:"Haïku mondial", year:"1905–", type:"hybrid",
                  detail:"Couchoud (français, 1905), Pound (imagisme anglais, 1913), Tablada (espagnol, 1919), Kerouac (Beat, 1950s), Haiku Society of America (1968). Le haïku est désormais pratiqué dans plus de 50 langues.",
                  hybrid:true}
              ]}
          ]},
        { id:"vers-mesure", label:"Vers classique mesuré", year:"XVIe–XVIIIe s.", type:"main",
          detail:"Alexandrin français (Ronsard, Racine, Hugo), iambe anglais (Shakespeare, Milton), hendécasyllabe italien (Pétrarque, Dante). Systèmes prosodiques nationaux fondés sur la syllabe ou l'accent. Domination incontestée jusqu'au XIXe s.",
          children:[
            { id:"vers-libre-tr", label:"Vers libre", year:"1856–", type:"main",
              detail:"Whitman (Leaves of Grass, 1856), Laforgue/Rimbaud (1886), Maïakovski (vers-escalier, 1912), Eliot (The Waste Land, 1922). Libération de la contrainte métrique. Le vers libre devient la forme dominante de la poésie mondiale au XXe s. Voir l'Atlas pour la diffusion géographique.",
              children:[
                { id:"imagisme", label:"Imagisme", year:"1912–1920", type:"branch",
                  detail:"Pound, H.D., Amy Lowell. Image directe, vers libres brefs, économie verbale absolue. Influence décisive sur le vers libre anglophone. Lien explicite avec la poésie chinoise et le haïku japonais."},
                { id:"surreal-po", label:"Poésie surréaliste", year:"1924–", type:"branch",
                  detail:"Breton (Nadja, 1928), Éluard, Desnos, Aragon. Automatisme psychique, images incongmmes, vers libres sans ponctuation. Influence Césaire (Négritude), Paz (Mexique), Lorca (Espagne).",
                  hybrid:true},
                { id:"slam", label:"Slam & poésie orale contemporaine", year:"1984–", type:"hybrid",
                  detail:"Marc Smith (Chicago, 1984) invente le slam poetry. Poésie orale-performative héritant du spoken word, du jazz, du hip-hop et de la tradition orale africaine et caribéenne. Retour de la dimension sonore et scénique de la poésie.",
                  hybrid:true}
              ]},
            { id:"symbolisme", label:"Symbolisme", year:"1857–1900", type:"branch",
              detail:"Baudelaire (Les Fleurs du mal, 1857), Verlaine, Mallarmé, Rimbaud. Musicalité, correspondances, obscurité voulue. Le symbolisme engendre le vers libre (Kahn, Laforgue) et le modernisme international."}
          ]}
      ]
    }
  }
};

/* ═══════════════════════════════════════
   COLORS PER TYPE
   ═══════════════════════════════════════ */
const TYPE_COLOR = {
  root:   { fill:"rgba(201,162,39,0.22)", stroke:"#c9a227", r:16 },
  main:   { fill:"rgba(212,168,73,0.14)", stroke:"#d4a849", r:12 },
  branch: { fill:"rgba(100,180,150,0.14)", stroke:"#5ab08a", r:9 },
  hybrid: { fill:"rgba(180,100,200,0.14)", stroke:"#b464c8", r:9 }
};

let currentTree = "roman";
let selectedNode = null;

/* ═══════════════════════════════════════
   LAYOUT: custom horizontal tree
   ═══════════════════════════════════════ */
function flattenTree(node, depth=0, parent=null) {
  const n = { ...node, depth, parent, children: undefined };
  const result = [n];
  if (node.children) {
    for (const ch of node.children) {
      result.push(...flattenTree(ch, depth+1, node.id));
    }
  }
  return result;
}

function buildEdges(node, edges=[]) {
  if (node.children) {
    for (const ch of node.children) {
      edges.push({ source: node.id, target: ch.id, hybrid: !!ch.hybrid });
      buildEdges(ch, edges);
    }
  }
  return edges;
}

function layoutTree(rootNode) {
  /* Use d3 tree layout */
  const hierarchy = d3.hierarchy(rootNode, d => d.children);
  const treeLayout = d3.tree().nodeSize([60, 220]);
  treeLayout(hierarchy);
  return hierarchy;
}

function renderTree(treeKey) {
  const data = TREES[treeKey];
  document.getElementById("tree-desc").textContent = data.desc;

  const svg = d3.select("#tree-svg");
  svg.selectAll("*").remove();

  const hier = layoutTree(data.root);
  const nodes = hier.descendants();
  const links = hier.links();

  /* Compute bounding box */
  const xVals = nodes.map(n => n.x);
  const yVals = nodes.map(n => n.y);
  const xMin = Math.min(...xVals), xMax = Math.max(...xVals);
  const yMin = Math.min(...yVals), yMax = Math.max(...yVals);
  const padX = 40, padY = 60;
  const W = (yMax - yMin) + padY * 2 + 240; // extra for labels
  const H = (xMax - xMin) + padX * 2;

  svg.attr("width", W).attr("height", H + 20);

  const g = svg.append("g").attr("transform", `translate(${padY},${padX - xMin})`);

  /* Links */
  const linkGen = d3.linkHorizontal().x(d => d.y).y(d => d.x);

  g.selectAll(".tree-link")
    .data(links)
    .join("path")
    .attr("class", d => "tree-link" + (d.target.data.hybrid ? " tree-link-hybrid" : ""))
    .attr("d", linkGen);

  /* Nodes */
  const nodeG = g.selectAll(".node-group")
    .data(nodes)
    .join("g")
    .attr("class","node-group")
    .attr("transform", d => `translate(${d.y},${d.x})`)
    .on("click", (evt, d) => selectNode(d.data));

  nodeG.each(function(d) {
    const tc = TYPE_COLOR[d.data.type] || TYPE_COLOR.branch;
    d3.select(this).append("circle")
      .attr("class","node-circle")
      .attr("r", d.data.id === selectedNode ? tc.r * 1.35 : tc.r)
      .style("fill", tc.fill)
      .style("stroke", tc.stroke)
      .style("stroke-width", d.data.id === selectedNode ? 2.5 : 1.8);
  });

  /* Labels — right side or left depending on depth */
  nodeG.append("text")
    .attr("class","node-label")
    .attr("x", d => d.children ? -18 : 18)
    .attr("text-anchor", d => d.children ? "end" : "start")
    .text(d => d.data.label);

  nodeG.append("text")
    .attr("class","node-year")
    .attr("x", d => d.children ? -18 : 18)
    .attr("y", 14)
    .attr("text-anchor", d => d.children ? "end" : "start")
    .text(d => d.data.year || "");
}

function selectNode(nodeData) {
  selectedNode = nodeData.id;
  /* Update detail panel */
  const tc = TYPE_COLOR[nodeData.type] || TYPE_COLOR.branch;
  const typeLabel = {root:"Forme souche",main:"Forme principale",branch:"Sous-genre / ramification",hybrid:"Forme hybride"}[nodeData.type]||"";
  document.getElementById("detail-inner").innerHTML = `
    <div class="detail-title">${nodeData.label}</div>
    <div class="detail-meta" style="color:${tc.stroke}">${typeLabel}${nodeData.year ? " · " + nodeData.year : ""}</div>
    <div class="detail-text">${nodeData.detail||""}</div>
  `;
  /* Re-render to highlight selected node */
  renderTree(currentTree);
}

function switchTree(key) {
  currentTree = key;
  selectedNode = null;
  document.querySelectorAll(".tree-btn").forEach(b => b.classList.toggle("active", b.dataset.tree === key));
  document.getElementById("detail-inner").innerHTML = '<p class="detail-placeholder">Cliquez sur un nœud pour afficher les détails.</p>';
  renderTree(key);
}

/* Initial render */
renderTree("roman");
window.addEventListener("resize", () => renderTree(currentTree));
</script>
</body>
</html>
